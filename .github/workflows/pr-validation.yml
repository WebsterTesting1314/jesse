name: Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # PR æ¨™é¡Œå’Œæè¿°æª¢æŸ¥
  pr-validation:
    name: Validate PR Format
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Check PR title format
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $TITLE"
          
          # æª¢æŸ¥æ¨™é¡Œæ ¼å¼: type(scope): description
          if [[ ! "$TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)(\(.+\))?\!?:\ .+ ]]; then
            echo "âŒ PR æ¨™é¡Œæ ¼å¼ä¸æ­£ç¢º!"
            echo "æ­£ç¢ºæ ¼å¼: type(scope): description"
            echo "ä¾‹å¦‚: feat(core): add new trading strategy"
            echo "é¡å‹: feat, fix, docs, style, refactor, test, chore, perf, ci, build"
            exit 1
          fi
          echo "âœ… PR æ¨™é¡Œæ ¼å¼æ­£ç¢º"
      
      - name: Check PR description
        run: |
          BODY="${{ github.event.pull_request.body }}"
          if [ -z "$BODY" ] || [ "$BODY" == "null" ]; then
            echo "âŒ PR æè¿°ä¸èƒ½ç‚ºç©º!"
            echo "è«‹æ·»åŠ  PR æè¿°èªªæ˜è®Šæ›´å…§å®¹"
            exit 1
          fi
          echo "âœ… PR æè¿°å·²æä¾›"
      
      - name: Check for breaking changes
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"
          
          if [[ "$TITLE" =~ \! ]] || [[ "$BODY" =~ "BREAKING CHANGE" ]]; then
            echo "âš ï¸  æª¢æ¸¬åˆ°ç ´å£æ€§è®Šæ›´!"
            echo "è«‹ç¢ºä¿:"
            echo "1. åœ¨ PR æè¿°ä¸­è©³ç´°èªªæ˜ç ´å£æ€§è®Šæ›´"
            echo "2. æ›´æ–°ç›¸é—œæ–‡æª”"
            echo "3. è€ƒæ…®å‘å¾Œå…¼å®¹æ€§"
            # ä¸é€€å‡ºï¼Œåªæ˜¯è­¦å‘Š
          fi

  # æª¢æŸ¥æ–‡ä»¶è®Šæ›´ç¯„åœ
  change-detection:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      core-changed: ${{ steps.changes.outputs.core }}
      contracts-changed: ${{ steps.changes.outputs.contracts }}
      defi-mev-changed: ${{ steps.changes.outputs.defi-mev }}
      docs-changed: ${{ steps.changes.outputs.docs }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            core:
              - 'core/**'
            contracts:
              - 'contracts/**'
            defi-mev:
              - 'jesse-defi-mev/**'
            docs:
              - 'docs/**'
              - '*.md'

  # é‹è¡Œé‡å°æ€§æ¸¬è©¦
  targeted-tests:
    name: Targeted Tests
    runs-on: ubuntu-latest
    needs: change-detection
    
    strategy:
      matrix:
        component: [core, contracts, defi-mev]
    
    steps:
      - name: Skip if no changes
        if: |
          (matrix.component == 'core' && needs.change-detection.outputs.core-changed != 'true') ||
          (matrix.component == 'contracts' && needs.change-detection.outputs.contracts-changed != 'true') ||
          (matrix.component == 'defi-mev' && needs.change-detection.outputs.defi-mev-changed != 'true')
        run: |
          echo "â­ï¸ Skipping ${{ matrix.component }} tests - no changes detected"
          exit 0
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run component tests
        run: |
          echo "ğŸ§ª Running tests for ${{ matrix.component }}"
          case "${{ matrix.component }}" in
            core)
              echo "Testing Jesse Core..."
              # é€™è£¡æœƒè¢« CI æµç¨‹è™•ç†
              ;;
            contracts)
              echo "Testing Smart Contracts..."
              # é€™è£¡æœƒè¢« CI æµç¨‹è™•ç†
              ;;
            defi-mev)
              echo "Testing DeFi MEV..."
              # é€™è£¡æœƒè¢« CI æµç¨‹è™•ç†
              ;;
          esac

  # ä»£ç¢¼è¦†è“‹ç‡è®ŠåŒ–æª¢æŸ¥
  coverage-check:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    needs: change-detection
    if: |
      needs.change-detection.outputs.core-changed == 'true' ||
      needs.change-detection.outputs.contracts-changed == 'true' ||
      needs.change-detection.outputs.defi-mev-changed == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coverage diff-cover
      
      - name: Calculate coverage diff
        run: |
          echo "ğŸ“Š è¨ˆç®—ä»£ç¢¼è¦†è“‹ç‡è®ŠåŒ–..."
          # é€™è£¡éœ€è¦èˆ‡ CI æµç¨‹é›†æˆï¼Œç²å–åŸºç¤åˆ†æ”¯å’Œç•¶å‰åˆ†æ”¯çš„è¦†è“‹ç‡
          echo "âš ï¸  ç¢ºä¿æ–°ä»£ç¢¼çš„æ¸¬è©¦è¦†è“‹ç‡ä¸ä½æ–¼80%"

  # æ€§èƒ½å›æ­¸æª¢æŸ¥
  performance-regression:
    name: Performance Regression Check
    runs-on: ubuntu-latest
    needs: change-detection
    if: needs.change-detection.outputs.core-changed == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest-benchmark
      
      - name: Run performance benchmarks
        run: |
          echo "âš¡ é‹è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦..."
          echo "æª¢æŸ¥æ˜¯å¦æœ‰æ€§èƒ½å›æ­¸..."
          # é€™è£¡éœ€è¦æ¯”è¼ƒèˆ‡ä¸»åˆ†æ”¯çš„æ€§èƒ½å·®ç•°

  # æ–‡æª”æ›´æ–°æª¢æŸ¥
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    needs: change-detection
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check if docs need update
        if: |
          needs.change-detection.outputs.core-changed == 'true' ||
          needs.change-detection.outputs.contracts-changed == 'true' ||
          needs.change-detection.outputs.defi-mev-changed == 'true'
        run: |
          echo "ğŸ” æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ–‡æª”..."
          
          # æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„å…¬å…± API
          git diff origin/main...HEAD --name-only | grep -E "\.(py|sol)$" | while read file; do
            if git diff origin/main...HEAD "$file" | grep -E "^(\+.*def |^(\+.*class |^\+.*function )" > /dev/null; then
              echo "âš ï¸  æª¢æ¸¬åˆ°æ–°çš„å…¬å…± API åœ¨ $file"
              echo "è«‹è€ƒæ…®æ›´æ–°ç›¸é—œæ–‡æª”"
            fi
          done
      
      - name: Build docs to check for errors
        if: needs.change-detection.outputs.docs-changed == 'true'
        run: |
          echo "ğŸ“š æ§‹å»ºæ–‡æª”æª¢æŸ¥éŒ¯èª¤..."
          # å®‰è£ä¸¦æ§‹å»ºæ–‡æª”
          pip install mkdocs mkdocs-material
          mkdocs build --strict

  # å®‰å…¨æƒæï¼ˆè¼•é‡ç´šï¼‰
  security-scan:
    name: Quick Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run security scan
        run: |
          echo "ğŸ”’ é‹è¡Œå¿«é€Ÿå®‰å…¨æƒæ..."
          
          # æª¢æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿä¿¡æ¯
          if grep -r -E "(password|secret|key|token).*(=|:)" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "âš ï¸  æª¢æ¸¬åˆ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯æ´©éœ²"
            echo "è«‹æª¢æŸ¥ä¸¦ç§»é™¤ä»»ä½•ç¡¬ç·¨ç¢¼çš„æ•æ„Ÿä¿¡æ¯"
          fi
          
          # æª¢æŸ¥ä¾è³´æ›´æ–°
          echo "æª¢æŸ¥ä¾è³´å®‰å…¨æ€§..."

  # PR æ¨™ç±¤è‡ªå‹•æ·»åŠ 
  auto-labeling:
    name: Auto Labeling
    runs-on: ubuntu-latest
    needs: [change-detection, pr-validation]
    
    steps:
      - name: Add labels based on changes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const labels = [];
            
            // æ ¹æ“šè®Šæ›´é¡å‹æ·»åŠ æ¨™ç±¤
            if ('${{ needs.change-detection.outputs.core-changed }}' === 'true') {
              labels.push('core');
            }
            if ('${{ needs.change-detection.outputs.contracts-changed }}' === 'true') {
              labels.push('contracts');
            }
            if ('${{ needs.change-detection.outputs.defi-mev-changed }}' === 'true') {
              labels.push('defi-mev');
            }
            if ('${{ needs.change-detection.outputs.docs-changed }}' === 'true') {
              labels.push('documentation');
            }
            
            // æ ¹æ“š PR æ¨™é¡Œæ·»åŠ æ¨™ç±¤
            const title = pullRequest.title.toLowerCase();
            if (title.startsWith('feat')) labels.push('enhancement');
            if (title.startsWith('fix')) labels.push('bug');
            if (title.startsWith('docs')) labels.push('documentation');
            if (title.startsWith('perf')) labels.push('performance');
            if (title.includes('breaking') || title.includes('!')) labels.push('breaking-change');
            
            // æ·»åŠ æ¨™ç±¤
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }

  # ç¸½çµæª¢æŸ¥çµæœ
  pr-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [pr-validation, targeted-tests, coverage-check, docs-check, security-scan]
    if: always()
    
    steps:
      - name: Create summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ğŸ” PR é©—è­‰çµæœ
            
            | æª¢æŸ¥é …ç›® | ç‹€æ…‹ |
            |---------|------|
            | PR æ ¼å¼é©—è­‰ | ${{ needs.pr-validation.result == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }} |
            | é‡å°æ€§æ¸¬è©¦ | ${{ needs.targeted-tests.result == 'success' && 'âœ… é€šé' || needs.targeted-tests.result == 'skipped' && 'â­ï¸ è·³é' || 'âŒ å¤±æ•—' }} |
            | è¦†è“‹ç‡æª¢æŸ¥ | ${{ needs.coverage-check.result == 'success' && 'âœ… é€šé' || needs.coverage-check.result == 'skipped' && 'â­ï¸ è·³é' || 'âŒ å¤±æ•—' }} |
            | æ–‡æª”æª¢æŸ¥ | ${{ needs.docs-check.result == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }} |
            | å®‰å…¨æƒæ | ${{ needs.security-scan.result == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }} |
            
            ${needs.pr-validation.result === 'failure' ? 'âš ï¸ è«‹ä¿®å¾© PR æ ¼å¼å•é¡Œå¾Œé‡æ–°æäº¤' : ''}
            ${needs.targeted-tests.result === 'failure' ? 'âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸¦ä¿®å¾©' : ''}
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });