name: ðŸš€ Integrated Validation Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.10"
  NODE_VERSION: "18"

jobs:
  stage1-static-analysis:
    name: ðŸ“Š Stage 1 - Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort ruff mypy bandit safety
          pip install -r core/requirements.txt
      
      - name: ðŸŽ¨ Code Quality Gate
        run: |
          echo "::group::Black Formatting Check"
          black --check --diff core/ jesse-defi-mev/ scripts/
          echo "::endgroup::"
          
          echo "::group::Import Sorting Check"
          isort --check-only --diff core/ jesse-defi-mev/
          echo "::endgroup::"
          
          echo "::group::Ruff Linting"
          ruff check core/ jesse-defi-mev/ scripts/
          echo "::endgroup::"
          
          echo "::group::MyPy Type Checking"
          mypy core/jesse/ --ignore-missing-imports
          echo "::endgroup::"
      
      - name: ðŸ”’ Security Gate
        run: |
          echo "::group::Bandit Security Scan"
          bandit -r core/jesse/ jesse-defi-mev/ -f json -o bandit-report.json || true
          echo "::endgroup::"
          
          echo "::group::Safety Dependency Check"
          safety check --json --output safety-report.json || true
          echo "::endgroup::"
      
      - name: ðŸ“Š Upload Quality Metrics
        uses: codecov/codecov-action@v3
        with:
          flags: quality
          name: quality-analysis
          fail_ci_if_error: false

  stage2-functional-testing:
    name: ðŸ§ª Stage 2 - Functional Testing
    needs: stage1-static-analysis
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: jessepwd123
          POSTGRES_USER: jesse_user
          POSTGRES_DB: jesse_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:6
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pytest-mock
          pip install -r core/requirements.txt
          cd core && pip install -e .
      
      - name: ðŸ§ª Unit Testing Gate
        run: |
          echo "::group::Core Jesse Tests"
          cd core && pytest tests/ --cov=jesse --cov-report=xml --cov-report=html -v
          echo "::endgroup::"
      
      - name: ðŸ”— Integration Testing Gate
        run: |
          echo "::group::Database Integration Tests"
          cd core && pytest tests/integration/ --cov-append --cov-report=xml -v
          echo "::endgroup::"
      
      - name: âš¡ HFT Performance Tests
        run: |
          echo "::group::HFT Component Tests"
          cd core && python -m pytest tests/test_hft_*.py --cov-append --cov-report=xml -v
          echo "::endgroup::"
          
          echo "::group::HFT Benchmark Tests"
          cd core && python -c "
          from jesse.services.hft_benchmark import run_benchmark_suite
          results = run_benchmark_suite()
          print('HFT Benchmark Results:', results)
          "
          echo "::endgroup::"
      
      - name: ðŸŒ DeFi MEV Tests
        run: |
          echo "::group::DeFi Connector Tests"
          cd jesse-defi-mev && python -m pytest tests/ --cov=. --cov-append --cov-report=xml -v
          echo "::endgroup::"
      
      - name: ðŸ“Š Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./core/coverage.xml,./jesse-defi-mev/coverage.xml
          flags: functional
          name: functional-tests
          fail_ci_if_error: false

  stage3-performance-security:
    name: âš¡ Stage 3 - Performance & Security
    needs: stage2-functional-testing
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r core/requirements.txt
          cd core && pip install -e .
          # å®‰è£æ€§èƒ½æ¸¬è©¦å·¥å…·
          pip install memory-profiler psutil locust
      
      - name: âš¡ Performance Gate
        run: |
          echo "::group::HFT Latency Tests"
          python scripts/test_hft_latency.py
          echo "::endgroup::"
          
          echo "::group::Memory Usage Tests"
          python scripts/test_memory_usage.py
          echo "::endgroup::"
          
          echo "::group::Throughput Tests"
          python scripts/test_throughput.py
          echo "::endgroup::"
      
      - name: ðŸ” Security Gate
        run: |
          echo "::group::API Security Tests"
          python scripts/test_api_security.py
          echo "::endgroup::"
          
          echo "::group::Smart Contract Security (if exists)"
          if [ -d "contracts/src" ]; then
            echo "Running contract security tests..."
            # æ·»åŠ æ™ºèƒ½åˆç´„å®‰å…¨æ¸¬è©¦
          fi
          echo "::endgroup::"
      
      - name: âœ… Final Validation Gate
        run: |
          python scripts/validate_all_gates.py

  codecov-analysis:
    name: ðŸ“ˆ Codecov Analysis
    needs: [stage1-static-analysis, stage2-functional-testing, stage3-performance-security]
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ“Š Codecov Analysis
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./core/coverage.xml,./jesse-defi-mev/coverage.xml
          flags: complete
          name: jesse-hft-coverage
          fail_ci_if_error: true
          verbose: true

  taskmaster-update:
    name: ðŸ“‹ TaskMaster Status Update
    needs: codecov-analysis
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Update Task Status
        run: |
          # æå– commit message ä¸­çš„ä»»å‹™ ID
          TASK_ID=$(echo "${{ github.event.head_commit.message }}" | grep -oE 'task-[0-9]+(\.[0-9]+)?' || echo "")
          
          if [ -n "$TASK_ID" ]; then
            echo "Found task ID: $TASK_ID"
            
            # æ ¹æ“šå·¥ä½œæµç¨‹çµæžœæ±ºå®šç‹€æ…‹
            if [ "${{ needs.codecov-analysis.result }}" = "success" ]; then
              STATUS="done"
              MESSAGE="æ‰€æœ‰é©—è­‰é€šéŽï¼Œä»»å‹™å®Œæˆ"
            else
              STATUS="in-progress"
              MESSAGE="é©—è­‰å¤±æ•—ï¼Œéœ€è¦ä¿®å¾©å•é¡Œ"
            fi
            
            echo "Updating TaskMaster with status: $STATUS"
            # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„ TaskMaster API èª¿ç”¨
            # curl -X POST "https://api.taskmaster.ai/update" \
            #   -H "Authorization: Bearer ${{ secrets.TASKMASTER_TOKEN }}" \
            #   -d "{\"task_id\": \"$TASK_ID\", \"status\": \"$STATUS\", \"message\": \"$MESSAGE\"}"
          else
            echo "No task ID found in commit message"
          fi

  deploy:
    name: ðŸš€ Automated Deployment
    needs: codecov-analysis
    if: github.ref == 'refs/heads/main' && success()
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ³ Deploy to Staging
        run: |
          echo "Deploying to staging environment..."
          # docker build -t jesse-hft:latest .
          # docker push registry/jesse-hft:latest
      
      - name: ðŸŒ Production Deployment
        if: success()
        run: |
          echo "Deploying to production environment..."
          # kubectl apply -f k8s/production/
      
      - name: ðŸ“Š Post-Deployment Monitoring
        run: |
          echo "Starting post-deployment monitoring..."
          # python scripts/monitor_deployment.py

  summary:
    name: ðŸ“Š Pipeline Summary
    needs: [stage1-static-analysis, stage2-functional-testing, stage3-performance-security, codecov-analysis]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸš€ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Static Analysis | ${{ needs.stage1-static-analysis.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Functional Testing | ${{ needs.stage2-functional-testing.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance & Security | ${{ needs.stage3-performance-security.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Codecov Analysis | ${{ needs.codecov-analysis.result }} | - |" >> $GITHUB_STEP_SUMMARY
          
          # æ±ºå®šæ•´é«”ç‹€æ…‹
          if [ "${{ needs.codecov-analysis.result }}" = "success" ]; then
            echo "âœ… **Overall Status: SUCCESS** - All validation stages passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Overall Status: FAILED** - Some validation stages failed." >> $GITHUB_STEP_SUMMARY
          fi 