name: Monitoring & Health Checks

on:
  schedule:
    # æ¯å°æ™‚é‹è¡Œå¥åº·æª¢æŸ¥
    - cron: '0 * * * *'
    # æ¯å¤©é‹è¡Œå®Œæ•´ç›£æ§
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of check to run'
        required: true
        type: choice
        options:
          - health
          - performance
          - security
          - full

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  # å¥åº·æª¢æŸ¥
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.check_type == 'health' || inputs.check_type == 'full'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests psutil
      
      - name: Check core dependencies
        run: |
          echo "ğŸ” Checking core dependencies..."
          python -c "
          import pkg_resources
          import requests
          
          # æª¢æŸ¥ PyPI ä¸Šçš„æœ€æ–°ç‰ˆæœ¬
          def check_package_updates():
              with open('core/requirements.txt', 'r') as f:
                  packages = [line.strip() for line in f if line.strip() and not line.startswith('#')]
              
              outdated = []
              for package in packages[:5]:  # æª¢æŸ¥å‰5å€‹ä¸»è¦åŒ…
                  if '==' in package:
                      name, version = package.split('==')
                      try:
                          resp = requests.get(f'https://pypi.org/pypi/{name}/json', timeout=5)
                          if resp.status_code == 200:
                              latest = resp.json()['info']['version']
                              if version != latest:
                                  outdated.append(f'{name}: {version} -> {latest}')
                      except:
                          pass
              
              return outdated
          
          outdated = check_package_updates()
          if outdated:
              print('ğŸ“¦ Package updates available:')
              for pkg in outdated:
                  print(f'  - {pkg}')
          else:
              print('âœ… All checked packages are up to date')
          "
      
      - name: Check system resources
        run: |
          echo "ğŸ’¾ System Resources:"
          echo "Memory: $(free -h | awk 'NR==2{printf \"%.1f%% used\", $3*100/$2 }')"
          echo "Disk: $(df -h / | awk 'NR==2{print $5 \" used\"}')"
          echo "Load: $(uptime | awk -F'load average:' '{print $2}')"
      
      - name: Check external dependencies
        run: |
          echo "ğŸŒ External Dependencies Check:"
          
          # æª¢æŸ¥ PyPI é€£æ¥
          if curl -s --max-time 10 https://pypi.org > /dev/null; then
            echo "âœ… PyPI accessible"
          else
            echo "âŒ PyPI connection failed"
          fi
          
          # æª¢æŸ¥ Ethereum RPC
          if curl -s --max-time 10 -X POST https://eth-mainnet.alchemyapi.io/v2/demo \
               -H "Content-Type: application/json" \
               -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' > /dev/null; then
            echo "âœ… Ethereum RPC accessible"
          else
            echo "âŒ Ethereum RPC connection failed"
          fi

  # æ€§èƒ½ç›£æ§
  performance-monitoring:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.check_type == 'performance' || inputs.check_type == 'full'
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: jesse_user
          POSTGRES_PASSWORD: password123
          POSTGRES_DB: jesse_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:6
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest-benchmark memory-profiler psutil
          pip install -r core/requirements.txt
          cd core && pip install -e .
      
      - name: Run performance benchmarks
        run: |
          cd core
          echo "âš¡ Running performance benchmarks..."
          
          # å‰µå»ºç°¡å–®çš„æ€§èƒ½æ¸¬è©¦
          cat > benchmark_test.py << 'EOF'
          import pytest
          import jesse.indicators as ta
          import numpy as np
          
          @pytest.mark.benchmark(group="indicators")
          def test_sma_performance(benchmark):
              data = np.random.random(10000)
              result = benchmark(ta.sma, data, 20)
              assert len(result) == len(data)
          
          @pytest.mark.benchmark(group="indicators")  
          def test_ema_performance(benchmark):
              data = np.random.random(10000)
              result = benchmark(ta.ema, data, 20)
              assert len(result) == len(data)
          EOF
          
          pytest benchmark_test.py --benchmark-json=benchmark.json --benchmark-disable-gc
          
          # åˆ†æçµæœ
          python -c "
          import json
          with open('benchmark.json', 'r') as f:
              data = json.load(f)
          
          print('ğŸ“Š Performance Results:')
          for bench in data['benchmarks']:
              name = bench['name']
              mean = bench['stats']['mean']
              stddev = bench['stats']['stddev']
              print(f'  {name}: {mean:.6f}s Â± {stddev:.6f}s')
          "
      
      - name: Memory usage analysis
        run: |
          echo "ğŸ’¾ Memory Usage Analysis:"
          python -c "
          import psutil
          import os
          
          process = psutil.Process(os.getpid())
          memory_info = process.memory_info()
          
          print(f'RSS: {memory_info.rss / 1024 / 1024:.1f} MB')
          print(f'VMS: {memory_info.vms / 1024 / 1024:.1f} MB')
          
          # æª¢æŸ¥ç³»çµ±å…§å­˜
          system_memory = psutil.virtual_memory()
          print(f'System Memory Usage: {system_memory.percent:.1f}%')
          "
      
      - name: Database performance check
        run: |
          echo "ğŸ—„ï¸ Database Performance:"
          python -c "
          import time
          import psycopg2
          
          # é€£æ¥æ¸¬è©¦
          start = time.time()
          conn = psycopg2.connect(
              host='localhost',
              port=5432,
              database='jesse_db',
              user='jesse_user',
              password='password123'
          )
          connect_time = time.time() - start
          
          # æŸ¥è©¢æ¸¬è©¦
          cur = conn.cursor()
          start = time.time()
          cur.execute('SELECT 1')
          query_time = time.time() - start
          
          print(f'Connection time: {connect_time:.3f}s')
          print(f'Query time: {query_time:.3f}s')
          
          conn.close()
          "

  # å®‰å…¨ç›£æ§
  security-monitoring:
    name: Security Monitoring
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.check_type == 'security' || inputs.check_type == 'full'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install security tools
        run: |
          pip install safety bandit semgrep
      
      - name: Run security scans
        run: |
          echo "ğŸ”’ Security Monitoring:"
          
          # ä¾è³´æ¼æ´æª¢æŸ¥
          echo "Checking dependency vulnerabilities..."
          safety check --json --output safety-report.json || true
          
          # ä»£ç¢¼å®‰å…¨æª¢æŸ¥
          echo "Running code security analysis..."
          bandit -r core/jesse/ jesse-defi-mev/ -f json -o bandit-report.json || true
          
          # åˆ†æçµæœ
          python -c "
          import json
          import os
          
          # Safety å ±å‘Š
          if os.path.exists('safety-report.json'):
              with open('safety-report.json', 'r') as f:
                  safety_data = json.load(f)
              
              vulns = safety_data.get('vulnerabilities', [])
              if vulns:
                  print(f'âš ï¸  Found {len(vulns)} dependency vulnerabilities')
                  for vuln in vulns[:3]:  # é¡¯ç¤ºå‰3å€‹
                      print(f'  - {vuln.get(\"package_name\", \"unknown\")}')
              else:
                  print('âœ… No dependency vulnerabilities found')
          
          # Bandit å ±å‘Š
          if os.path.exists('bandit-report.json'):
              with open('bandit-report.json', 'r') as f:
                  bandit_data = json.load(f)
              
              issues = bandit_data.get('results', [])
              high_issues = [i for i in issues if i.get('issue_severity') == 'HIGH']
              
              if high_issues:
                  print(f'âš ï¸  Found {len(high_issues)} high severity security issues')
              else:
                  print('âœ… No high severity security issues found')
          "
      
      - name: Check for leaked secrets
        run: |
          echo "ğŸ” Checking for potential secret leaks..."
          
          # ç°¡å–®çš„ç§˜å¯†æª¢æŸ¥
          if grep -r -E "(password|secret|key|token).*=.*['\"][^'\"]{8,}['\"]" . \
               --exclude-dir=.git \
               --exclude-dir=node_modules \
               --exclude-dir=.github \
               --exclude="*.md" \
               --exclude="*.yml" \
               --exclude="*.yaml"; then
            echo "âš ï¸  Potential secrets found in code"
          else
            echo "âœ… No obvious secrets detected"
          fi

  # ä¾è³´æ›´æ–°æª¢æŸ¥
  dependency-update-check:
    name: Dependency Update Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.check_type == 'full'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Check for outdated packages
        run: |
          pip install pip-check-reqs requests
          
          echo "ğŸ“¦ Checking for outdated Python packages..."
          
          python -c "
          import subprocess
          import requests
          import json
          
          # ç²å–ç•¶å‰å®‰è£çš„åŒ…
          result = subprocess.run(['pip', 'freeze'], capture_output=True, text=True)
          installed = {}
          
          for line in result.stdout.split('\n'):
              if '==' in line:
                  name, version = line.split('==')
                  installed[name.lower()] = version
          
          # æª¢æŸ¥ä¸»è¦åŒ…çš„æ›´æ–°
          important_packages = ['numpy', 'pandas', 'fastapi', 'pytest']
          updates_available = []
          
          for package in important_packages:
              if package in installed:
                  try:
                      resp = requests.get(f'https://pypi.org/pypi/{package}/json', timeout=10)
                      if resp.status_code == 200:
                          latest = resp.json()['info']['version']
                          current = installed[package]
                          if current != latest:
                              updates_available.append(f'{package}: {current} -> {latest}')
                  except:
                      pass
          
          if updates_available:
              print('Updates available:')
              for update in updates_available:
                  print(f'  - {update}')
          else:
              print('âœ… Key packages are up to date')
          "

  # å‰µå»ºç›£æ§å ±å‘Š
  create-monitoring-report:
    name: Create Monitoring Report
    runs-on: ubuntu-latest
    needs: [health-check, performance-monitoring, security-monitoring, dependency-update-check]
    if: always() && (github.event_name == 'schedule' || inputs.check_type == 'full')
    
    steps:
      - name: Generate monitoring report
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸ” System Monitoring Report - ${new Date().toISOString().split('T')[0]}`;
            
            let report = `# ${title}\n\n`;
            report += `Generated on: ${new Date().toISOString()}\n\n`;
            
            // æª¢æŸ¥å„å€‹ job çš„ç‹€æ…‹
            const jobs = {
              'Health Check': '${{ needs.health-check.result }}',
              'Performance Monitoring': '${{ needs.performance-monitoring.result }}',  
              'Security Monitoring': '${{ needs.security-monitoring.result }}',
              'Dependency Update Check': '${{ needs.dependency-update-check.result }}'
            };
            
            report += '## ğŸ“Š Overall Status\n\n';
            
            for (const [job, status] of Object.entries(jobs)) {
              const icon = status === 'success' ? 'âœ…' : 
                          status === 'failure' ? 'âŒ' : 
                          status === 'skipped' ? 'â­ï¸' : 'âš ï¸';
              report += `- ${icon} ${job}: ${status}\n`;
            }
            
            report += '\n## ğŸ”§ Recommended Actions\n\n';
            
            let hasIssues = false;
            if (jobs['Security Monitoring'] === 'failure') {
              report += '- ğŸ”’ Review security scan results and address any high-priority issues\n';
              hasIssues = true;
            }
            
            if (jobs['Performance Monitoring'] === 'failure') {
              report += '- âš¡ Investigate performance regressions\n';
              hasIssues = true;
            }
            
            if (!hasIssues) {
              report += '- âœ… No immediate actions required\n';
            }
            
            report += '\n## ğŸ“ˆ Trends\n\n';
            report += '- Monitor system performance over time\n';
            report += '- Track dependency update frequency\n';
            report += '- Review security scan trends\n';
            
            report += '\n---\n*This report is automatically generated by GitHub Actions*';
            
            // å¦‚æœæ˜¯å®šæœŸé‹è¡Œä¸”æœ‰å•é¡Œï¼Œå‰µå»º issue
            if (hasIssues && context.eventName === 'schedule') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ Monitoring Alert - ${new Date().toISOString().split('T')[0]}`,
                body: report,
                labels: ['monitoring', 'alert']
              });
            }
            
            console.log(report);

  # æ¸…ç†èˆŠçš„ç›£æ§æ•¸æ“š
  cleanup:
    name: Cleanup Old Data
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Close old monitoring issues
        uses: actions/github-script@v7
        with:
          script: |
            // é—œé–‰è¶…é7å¤©çš„ç›£æ§ issue
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'monitoring',
              state: 'open'
            });
            
            for (const issue of issues) {
              const createdAt = new Date(issue.created_at);
              if (createdAt < sevenDaysAgo) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: 'ğŸ¤– Auto-closed: Monitoring issue older than 7 days'
                });
              }
            }