# Jesse 架构设计文档

## 目录

1. [系统概述](#系统概述)
2. [核心架构](#核心架构)
3. [模块详解](#模块详解)
4. [数据流程](#数据流程)
5. [技术栈](#技术栈)
6. [扩展性设计](#扩展性设计)

## 系统概述

Jesse采用模块化的架构设计，将交易系统的各个组件解耦，使得系统具有高度的可扩展性和可维护性。

### 架构原则

- **模块化**: 每个功能模块独立，便于维护和扩展
- **可测试性**: 所有核心组件都可以独立测试
- **高性能**: 使用NumPy和Numba优化计算密集型任务
- **可扩展**: 插件化设计，易于添加新功能

## 核心架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                             │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Web UI     │  │   CLI工具     │  │   API接口    │      │
│  └─────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        应用服务层                             │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  策略管理   │  │   回测引擎    │  │  实盘交易    │      │
│  └─────────────┘  └──────────────┘  └──────────────┘      │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  优化引擎   │  │   风险管理    │  │  监控告警    │      │
│  └─────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        核心引擎层                             │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  订单管理   │  │  仓位管理     │  │  事件处理    │      │
│  │  系统       │  │   系统        │  │    系统      │      │
│  └─────────────┘  └──────────────┘  └──────────────┘      │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  指标计算   │  │  数据处理     │  │  状态管理    │      │
│  │   引擎      │  │   引擎        │  │    引擎      │      │
│  └─────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        数据访问层                             │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ PostgreSQL  │  │    Redis      │  │  文件系统    │      │
│  │   数据库    │  │   缓存        │  │    存储      │      │
│  └─────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## 模块详解

### 1. 策略管理模块 (`jesse/strategies/`)

负责策略的加载、管理和执行。

```python
# 策略基类结构
class Strategy:
    # 核心决策方法
    def should_long(self) -> bool
    def should_short(self) -> bool
    def should_cancel(self) -> bool
    
    # 执行方法
    def go_long(self)
    def go_short(self)
    def update_position(self)
    
    # 事件处理
    def on_open_position(self)
    def on_close_position(self)
    def before(self)
    def after(self)
    
    # 风险管理
    def on_stop_loss(self)
    def on_take_profit(self)
```

### 2. 回测引擎 (`jesse/modes/backtest/`)

高性能的回测引擎，支持：
- 多品种同时回测
- 多时间框架数据
- 滑点和手续费模拟
- 详细的交易记录

### 3. 指标库 (`jesse/indicators/`)

包含300+技术指标：

```python
# 指标分类
indicators/
├── trend/          # 趋势指标 (MA, EMA, MACD等)
├── momentum/       # 动量指标 (RSI, STOCH等)
├── volatility/     # 波动率指标 (ATR, BB等)
├── volume/         # 成交量指标 (OBV, MFI等)
└── custom/         # 自定义指标
```

### 4. 数据管理 (`jesse/services/candle/`)

负责K线数据的获取、存储和管理：

```python
# 数据流程
Exchange API → Data Collector → Data Validator → Database
                                      ↓
                              Candle Manager → Strategy
```

### 5. 订单管理系统 (`jesse/services/broker/`)

处理所有订单相关操作：
- 订单创建和验证
- 订单执行和成交
- 仓位跟踪
- 盈亏计算

## 数据流程

### 回测模式数据流

```
历史数据 → 数据加载器 → 回测引擎 → 策略执行 → 订单生成
   ↓                                    ↓
数据库                              性能报告
```

### 实盘模式数据流

```
交易所API → 实时数据 → 策略执行 → 订单管理 → 交易所API
    ↑                                    ↓
    └──────────── 订单状态更新 ←─────────┘
```

## 技术栈

### 核心技术

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| 编程语言 | Python 3.10+ | 主要开发语言 |
| 数据库 | PostgreSQL | 数据持久化存储 |
| 缓存 | Redis | 高速数据缓存 |
| Web框架 | FastAPI | RESTful API |
| 前端 | Vue.js | Web界面 |
| 计算库 | NumPy/Pandas | 数据处理 |
| 优化 | Numba | JIT编译加速 |

### 第三方库

- **TA-Lib**: 技术分析库
- **Optuna**: 超参数优化
- **Ray**: 分布式计算
- **WebSocket**: 实时数据传输
- **SQLAlchemy**: ORM框架

## 扩展性设计

### 1. 插件系统

Jesse支持通过插件扩展功能：

```python
# 插件接口
class JessePlugin:
    def initialize(self, jesse_instance):
        """初始化插件"""
        pass
    
    def on_strategy_init(self, strategy):
        """策略初始化时调用"""
        pass
    
    def on_order_execute(self, order):
        """订单执行时调用"""
        pass
```

### 2. 自定义指标

轻松添加自定义技术指标：

```python
# 自定义指标示例
@jit
def my_custom_indicator(candles: np.ndarray, period: int = 14) -> float:
    """
    自定义指标计算
    """
    # 使用NumPy进行高效计算
    close_prices = candles[:, 2]
    return np.mean(close_prices[-period:])
```

### 3. 策略模板

提供多种策略模板，加速开发：

```python
# 策略模板
templates/
├── TrendFollowing     # 趋势跟踪模板
├── MeanReversion      # 均值回归模板
├── Arbitrage          # 套利模板
└── MachineLearning    # 机器学习模板
```

## 性能优化

### 1. 计算优化

- 使用NumPy向量化计算
- Numba JIT编译热点函数
- 多进程并行回测

### 2. 内存优化

- 数据分块加载
- 增量计算指标
- 智能垃圾回收

### 3. 数据库优化

- 索引优化
- 查询缓存
- 连接池管理

## 安全设计

### 1. API密钥管理

- 加密存储
- 权限隔离
- 定期轮换

### 2. 风险控制

- 仓位限制
- 止损强制执行
- 异常监控

### 3. 数据安全

- 本地化部署
- 数据加密
- 备份恢复

## 部署架构

### 单机部署

```
┌─────────────────┐
│   Jesse App     │
│  ┌───────────┐  │
│  │ Strategy  │  │
│  │ Engine    │  │
│  └───────────┘  │
│  ┌───────────┐  │
│  │PostgreSQL │  │
│  └───────────┘  │
│  ┌───────────┐  │
│  │  Redis    │  │
│  └───────────┘  │
└─────────────────┘
```

### 分布式部署

```
┌──────────────┐     ┌──────────────┐
│ Load Balancer│────►│  Jesse Web   │
└──────────────┘     └──────────────┘
                            │
                     ┌──────┴──────┐
                     ▼             ▼
              ┌──────────┐  ┌──────────┐
              │ Worker 1 │  │ Worker 2 │
              └──────────┘  └──────────┘
                     │             │
                     └──────┬──────┘
                            ▼
                     ┌──────────┐
                     │ Database │
                     │ Cluster  │
                     └──────────┘
```

## 开发最佳实践

### 1. 代码规范

- 遵循PEP 8规范
- 类型注解
- 完整的文档字符串

### 2. 测试策略

- 单元测试覆盖核心逻辑
- 集成测试验证完整流程
- 性能测试确保效率

### 3. 版本管理

- 语义化版本控制
- 完整的变更日志
- 向后兼容性

---

## 下一步

- 查看[快速开始指南](quickstart.md)了解如何使用Jesse
- 阅读[开发者文档](developer-guide.md)深入了解开发细节
- 参考[API文档](api-reference.md)了解所有可用接口